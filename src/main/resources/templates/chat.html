<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
        }
    </style>
</head>
<body>
<div class="chat-container container mt-4">
    <!-- Header with Theme Toggle and clear button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="text-center mb-0">Real-Time Chat</h1>
        <button id="toggleTheme" class="btn btn-outline-secondary btn-sm">
            Toggle Dark Mode
        </button>
        <button id="clearChat" class="btn btn-danger">Clear Chat</button>
    </div>

    <!-- Chat Window -->
    <div id="chat"
         class="border rounded p-3 mb-3"
         style="height: 300px; overflow-y: auto;">
    </div>

    <!-- Sender Name -->
    <div class="input-group mb-3">
        <input id="senderInput" type="text" class="form-control"
               placeholder="Your name...."/>
    </div>

    <!-- Message Input -->
    <div class="input-group mb-3">
        <input id="messageInput" type="text" class="form-control"
               placeholder="Type a message...."/>
        <button id="sendMessage" class="btn btn-primary">Send</button>
    </div>
</div>

<script>
    let stompClient = null;
 let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];

 // === Helper to avoid duplicate messages ===
 function isDuplicate(message) {
     return chatHistory.some(msg =>
         msg.sender === message.sender && msg.content === message.content
     );
 }

 // === Initialize theme on load ===
 function loadTheme() {
     const savedTheme = localStorage.getItem('theme') || 'light';
     document.body.setAttribute('data-bs-theme', savedTheme);
     document.getElementById('toggleTheme').textContent =
         savedTheme === 'light' ? 'Toggle Dark Mode' : 'Toggle Light Mode';
 }

 // === Toggle Theme ===
 function toggleTheme() {
     const body = document.body;
     const currentTheme = body.getAttribute('data-bs-theme');
     const newTheme = currentTheme === 'light' ? 'dark' : 'light';
     body.setAttribute('data-bs-theme', newTheme);
     localStorage.setItem('theme', newTheme);
     document.getElementById('toggleTheme').textContent =
         newTheme === 'light' ? 'Toggle Dark Mode' : 'Toggle Light Mode';
 }

 // === Load Chat History ===
 function loadChatHistory() {
     const chat = document.getElementById('chat');
     chat.innerHTML = '';
     chatHistory.forEach(msg => appendMessage(msg));
     chat.scrollTop = chat.scrollHeight;
 }

 // === Append a message to chat ===
 function appendMessage(message) {
     const chat = document.getElementById('chat');
     const messageElement = document.createElement('div');
     messageElement.textContent = `${message.sender}: ${message.content}`;
     messageElement.className = "border-bottom mb-1 pb-1";
     chat.appendChild(messageElement);
     chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
 }

// === Clear Chat ===
function clearChat() {
    if (confirm("Are you sure you want to clear all chat history?")) {
        chatHistory = [];
        localStorage.removeItem('chatHistory');
        document.getElementById('chat').innerHTML = '';
    }
}

 // === Connect to WebSocket ===
 function connect() {
     const socket = new SockJS('/chat');
     stompClient = Stomp.over(socket);
     stompClient.connect({}, function () {
         setConnected(true);
         stompClient.subscribe('/topic/messages', function (message) {
             const msg = JSON.parse(message.body);
             if (!isDuplicate(msg)) {  // ✅ Prevent duplicates
                 chatHistory.push(msg);
                 localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                 appendMessage(msg);
             }
         });
     });
 }

 function setConnected(connected) {
     document.getElementById('sendMessage').disabled = !connected;
 }

 // === Send Message ===
 function sendMessage() {
     const sender = document.getElementById('senderInput').value;
     const content = document.getElementById('messageInput').value.trim();
     if (!sender || !content) return;

     const chatMessage = { sender, content };
     if (!isDuplicate(chatMessage)) {  // ✅ Avoid local duplicate
         stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
         chatHistory.push(chatMessage);
         localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
         appendMessage(chatMessage);
     }

     document.getElementById('messageInput').value = '';
 }

 // === Event Listeners ===
 document.getElementById('toggleTheme').onclick = toggleTheme;
 document.getElementById('sendMessage').onclick = sendMessage;
 document.getElementById('clearChat').onclick = clearChat;


 // === Initialize on page load ===
 window.onload = function () {
     loadTheme();
     loadChatHistory();
     connect();
 };

</script>
</body>
</html>
